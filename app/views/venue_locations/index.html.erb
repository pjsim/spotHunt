
<div class ="row">
  <div class = "span12">
    <%= form_tag venue_locations_path, :method => :get do %>
      <p>
        <%= text_field_tag :search, params[:search], :class => 'search-query', :placeholder => 'Enter a suburb' %>
        <%= text_field_tag :radius, params[:radius], :id => 'filtered-pop', :class => 'search-query' %>
        <div id='population-range' style="width: 500px"></div>
        <%= submit_tag "Search", :name => nil %>
      </p>
    <% end %>
  </div>
</div>

<div class="row">
  <div class="span7">
    <%= gmaps4rails(@json) %>
  </div>
  <div class="span2">
  </div>
  <div class="span3">
    <h5>Nearest venues to <%= params[:search] %>:</h5>
    <% if @search_location %>
      <ul>
      <% for venue in @search_location.nearbys(1000) %>
        <div class="row">
          <div class="span8">
            <h4><%= link_to venue.name, venue %></h4>
            <h6>(<%= venue.distance.round(2) %> miles)</h6> 
          </div>
        </div>
        <div class="row">
          <div class="span2">
            <a href="#" class="thumbnail">
              <%= image_tag venue.avatar.thumb %>
            </a>
          </div>
        </div>
        <div class="row">
          <div class="span8">
            <p>
              <i class="icon-map-marker"></i> <%= venue.address %><br>
              <% if venue.website? %>
                <i class="icon-globe"></i> <%= auto_link venue.website %><br> 
              <% end %>
              <% if !venue.tag_list.empty? %>
                <i class="icon-tags"></i> Tags : 
                <a href="#"><span class="label label-info"><%= venue.tag_list %></span></a>
              <% end %>
            </p>
          </div>
        </div>
      <% end %>
      </ul>
    <% end %>
  </div>
</div>








<script type="text/javascript">
  $(document).ready(function() {
    Gmaps.map.callback = function() {

      var PopulationFilter = {
        min: 1
      };

      // $( "#filtered-pop" ).val(PopulationFilter.min)
      $( "#filtered-pop" ).val("Enter radius in miles here..")
      $("#population-range").slider({
        range: false,
        min: PopulationFilter.min,
        values: [PopulationFilter.min],
        slide: function(event, ui) {
          $( "#filtered-pop" ).val(ui.values[ 0 ])
          PopulationFilter.min = ui.values[ 0 ]
          PopulationFilter.max = ui.values[ 1 ]
          applyFilters()
        }
      });

      var VisibleMarkers = function() {
      var filtered = _.reject(Gmaps.map.markers, function(marker) {
          return marker.population < PopulationFilter.min || marker.population > PopulationFilter.max;
        });
        return filtered
       }

      var applyFilters = function() {
        _.each(Gmaps.map.markers, function(marker) {
          Gmaps.map.hideMarker(marker)
        })
        _.each(VisibleMarkers(), function(marker) {
          Gmaps.map.showMarker(marker)
        })
      };
   }
});
</script>

